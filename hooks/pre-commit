#!/usr/bin/env bash
# Living Documentation Framework - Pre-Commit Hook
# Validates documentation requirements before allowing commit

set -e

# Get project root (where .git is)
PROJECT_ROOT=$(git rev-parse --show-toplevel)

# Load configuration
FRAMEWORK_HOOKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRAMEWORK_ROOT="$(cd "$FRAMEWORK_HOOKS_DIR/.." && pwd)"

if [ -f "$FRAMEWORK_ROOT/core/load-config.sh" ]; then
    source "$FRAMEWORK_ROOT/core/load-config.sh"
else
    echo "Warning: Configuration loader not found"
    echo "Skipping documentation checks"
    exit 0
fi

# Colors for output (check terminal support)
if [ -t 1 ]; then
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    GREEN='\033[0;32m'
    NC='\033[0m'
else
    RED=''
    YELLOW=''
    GREEN=''
    NC=''
fi

echo -e "${GREEN}Living Documentation - Pre-Commit Validation${NC}"
echo ""

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

if [ -z "$CHANGED_FILES" ]; then
    echo "No files staged for commit"
    exit 0
fi

FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
echo "Files staged: $FILE_COUNT"
echo ""

# ============================================================================
# CHECK 1: Blast Radius Warning
# ============================================================================
BLAST_THRESHOLD="${LDF_BLAST_THRESHOLD:-5}"
if [ "$FILE_COUNT" -gt "$BLAST_THRESHOLD" ]; then
    echo -e "${YELLOW}BLAST RADIUS WARNING${NC}"
    echo "   Large change detected: $FILE_COUNT files"
    echo "   Consider splitting into smaller commits"
    echo ""
fi

# ============================================================================
# CHECK 2: Changelog Updated
# ============================================================================
CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -E "\.$LDF_CODE_EXT$" | wc -l || echo "0")

if [ "$CODE_CHANGED" -gt 0 ]; then
    CHANGELOG_UPDATED=$(echo "$CHANGED_FILES" | grep -c "CHANGELOG" || echo "0")

    if [ "$CHANGELOG_UPDATED" -eq 0 ]; then
        echo -e "${YELLOW}CHANGELOG NOT UPDATED${NC}"
        echo "   Code files changed but CHANGELOG.md not updated"
        echo "   Consider adding an entry to track this change"
        echo ""
    fi
fi

# ============================================================================
# CHECK 3: Tier A File Validation (if CODE_DOC_MAP exists)
# ============================================================================
if [ -f "$PROJECT_ROOT/$LDF_CODE_DOC_MAP" ]; then
    TIER_A_CHANGED=0
    while IFS= read -r file; do
        if echo "$file" | grep -qE "\.$LDF_CODE_EXT$"; then
            if grep -q "TIER A.*\`$file\`" "$PROJECT_ROOT/$LDF_CODE_DOC_MAP" 2>/dev/null; then
                TIER_A_CHANGED=$((TIER_A_CHANGED + 1))
            fi
        fi
    done <<< "$CHANGED_FILES"

    if [ "$TIER_A_CHANGED" -gt 0 ]; then
        echo -e "${YELLOW}Tier A Files Changed: $TIER_A_CHANGED${NC}"

        INVARIANTS_UPDATED=$(echo "$CHANGED_FILES" | grep -c "INVARIANTS" || echo "0")

        if [ "$INVARIANTS_UPDATED" -eq 0 ]; then
            echo -e "${RED}ERROR: Tier A files changed but INVARIANTS.md not updated${NC}"
            echo "   Tier A files are critical and require invariant documentation"
            echo "   Please:"
            echo "     1. Read relevant invariants in docs/INVARIANTS.md"
            echo "     2. Cite which invariants you're respecting"
            echo "     3. Add new invariants if needed"
            echo ""
            echo "   To skip this check (emergency only): git commit --no-verify"
            exit 1
        else
            echo "   INVARIANTS.md updated"
        fi
        echo ""
    fi
fi

# ============================================================================
# CHECK 4: Version Consistency (if version file exists)
# ============================================================================
if [ -f "$PROJECT_ROOT/$LDF_VERSION_FILE" ] && [ -f "$PROJECT_ROOT/$LDF_CHANGELOG" ]; then
    # Extract version using grep -o (portable) instead of grep -P
    FILE_VERSION=$(grep -oE '[0-9]+\.[0-9]+\.[0-9]+' "$PROJECT_ROOT/$LDF_VERSION_FILE" 2>/dev/null | head -1 || echo "")

    CHANGELOG_VERSION=$(grep -m1 "^## \[" "$PROJECT_ROOT/$LDF_CHANGELOG" | sed 's/## \[\([^]]*\)\].*/\1/' || echo "")

    if [ -n "$FILE_VERSION" ] && [ -n "$CHANGELOG_VERSION" ]; then
        if [ "$FILE_VERSION" != "$CHANGELOG_VERSION" ]; then
            echo -e "${RED}ERROR: Version mismatch${NC}"
            echo "   $LDF_VERSION_FILE:  $FILE_VERSION"
            echo "   CHANGELOG.md:       $CHANGELOG_VERSION"
            echo ""
            echo "   Please sync versions before committing"
            exit 1
        fi
    fi
fi

# ============================================================================
# SUCCESS
# ============================================================================
echo -e "${GREEN}Pre-commit checks passed${NC}"
echo ""

exit 0
